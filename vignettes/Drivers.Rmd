---
title: "Signature Variability Analysis of the mutational signatures of driver alterations with sigvar"
author:
  - name: "Nicolas Alcala"
    affiliation: "Rare Cancers Genomics Team, International Agency for Research on Cancer / World Health Organization"
    email: "alcalan@iarc.who.int"
date: "`r Sys.Date()`"
output:
  BiocStyle::html_document:
    toc: true
    toc_depth: 2
vignette: >
  %\VignetteIndexEntry{Mutational signatures of carcinogens}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(FAVA)
library(sigvar)
library(ggplot2)
library(stringr)
library(dplyr)
library(readr)
library(readxl)
library(patchwork)
```

# Introduction

This vignette details an example of using sigvar to analyse the relationship between variability of mutational signatures and driver alterations. 

# Dataset
This vignettes analyses the intogen dataset included in the sigvar package.

```{r }
head(EGFR_drivers_intogen_SBS96)
```

We will compare this profile with that of lung adenocarcinoma from the PCAWG cohort and lung squamous cell carcinoma from the Sherlock-Lung study
```{r }
Sherlock_SBS.tib  = read_tsv("/home/alcalan/evolution/data/signatures/non-smoker_lung_cancer_genomics/sherlock_232_SBS_Signature_Ratio.txt")
Sherlock.muts     = read_xlsx("/home/alcalan/evolution/data/signatures/non-smoker_lung_cancer_genomics/41588_2021_920_MOESM4_ESM.xlsx",sheet=4,skip=1)
Sherlock.refs     = read_xlsx("/home/alcalan/evolution/data/signatures/non-smoker_lung_cancer_genomics/41588_2021_920_MOESM4_ESM.xlsx",sheet=7,skip=2) %>% arrange(Type,Subtype)
Sherlock.metadata = read_xlsx("/home/alcalan/evolution/data/signatures/non-smoker_lung_cancer_genomics/41588_2021_920_MOESM4_ESM.xlsx",sheet=1,skip=1)
```

We will also investigate the mutational spectra of drivers from mice exposed or non-exposed to carcinogens from Riva et al. 2020
```{r }
mutsig_carcinogens_mice_SBS
mutsig_carcinogens_mice_SBS.refs
drivers
```

## Data preparation
We compute the mutational profiles of each sample based on their signature attributions

## Sherlock samples
```{r}
sigs_LUAD.S = colnames(Sherlock_SBS.tib[,-1])
MutType = Sherlock.refs %>% dplyr::select(Type,Subtype)

Sherlock_SBS       = as.matrix(Sherlock_SBS.tib[,-1])
rownames(Sherlock_SBS) = Sherlock_SBS.tib$Sample
Sherlock.refs = as.matrix(Sherlock.refs[,sigs_LUAD.S])
colnames(Sherlock.refs) = sigs_LUAD.S
rownames(Sherlock.refs) = paste0(MutType$Type,",",MutType$Subtype)

Sherlock_MutProf_LUAD = Sherlock_SBS%*%t(Sherlock.refs)
```

## ESCC across continents
```{r}
sigs_ESCC.S = colnames(Sherlock_SBS.tib[,-1])
MutType = Sherlock.refs %>% dplyr::select(Type,Subtype)

Sherlock_SBS       = as.matrix(Sherlock_SBS.tib[,-1])
rownames(Sherlock_SBS) = Sherlock_SBS.tib$Sample
Sherlock.refs = as.matrix(Sherlock.refs[,sigs_LUAD.S])
colnames(Sherlock.refs) = sigs_LUAD.S
rownames(Sherlock.refs) = paste0(MutType$Type,",",MutType$Subtype)

Sherlock_MutProf_LUAD = Sherlock_SBS%*%t(Sherlock.refs)
```

## Riva et al. samples
```{r}
sigs_mice.S = colnames(mutsig_carcinogens_mice_SBS[,2:12])
#MutType = Sherlock.refs %>% dplyr::select(Type,Subtype)

Riva_SBS       = as.matrix(mutsig_carcinogens_mice_SBS[,2:12])
rownames(Riva_SBS) = mutsig_carcinogens_mice_SBS$Sample
Riva.refs = as.matrix(mutsig_carcinogens_mice_SBS.refs[,sigs_mice.S])
colnames(Riva.refs) = sigs_mice.S
rownames(Riva.refs) = paste0(mutsig_carcinogens_mice_SBS.refs$Type,",",mutsig_carcinogens_mice_SBS.refs$Subtype)

Riva_MutProf = Riva_SBS%*%t(Riva.refs)

drivers = drivers %>% mutate(Tissue = str_extract(sample,"[A-Z]+"), 
                             Chemical = str_remove_all(str_extract(sample,"_[A-Z_]+"),"^_|_$"), 
                             Type=str_extract(context,"[ATCG]>[ATCG]"),
                             Subtype=paste0(str_sub(context,1,1),str_sub(context,3,3),str_sub(context,7,7)) )

drivers.spectrum.lung.mice = drivers[!duplicated(drivers[,2:5]),] %>% filter(Tissue=="LUNG") %>% group_by(gene,Type,Subtype) %>% summarize(n=n())
drivers.spectrum.lung.mice.l = lapply(unique(drivers.spectrum.lung.mice$gene), function(x)  left_join(MutType,drivers.spectrum.lung.mice %>% filter(gene==x)) )
for(i in 1:length(drivers.spectrum.lung.mice.l)) drivers.spectrum.lung.mice.l[[i]]$n[is.na(drivers.spectrum.lung.mice.l[[i]]$n)] = 0
names(drivers.spectrum.lung.mice.l) = unique(drivers.spectrum.lung.mice$gene)

drivers.spectrum.liver.mice = drivers[!duplicated(drivers[,2:5]),] %>% filter(Tissue=="LIVER") %>% group_by(gene,Type,Subtype) %>% summarize(n=n())
drivers.spectrum.liver.mice.l = lapply(unique(drivers.spectrum.liver.mice$gene), function(x)  left_join(MutType,drivers.spectrum.liver.mice %>% filter(gene==x)) )
for(i in 1:length(drivers.spectrum.liver.mice.l)) drivers.spectrum.liver.mice.l[[i]]$n[is.na(drivers.spectrum.liver.mice.l[[i]]$n)] = 0
names(drivers.spectrum.liver.mice.l) = unique(drivers.spectrum.liver.mice$gene)
```

# Computing the probability of driver mutations
## LCINS
### EGFR
```{r}
prob_Sherlock_EGFR_drivers = sapply(1:nrow(Sherlock_MutProf_LUAD), function(i) Sherlock_MutProf_LUAD[i,]%*%(EGFR_drivers_intogen_SBS96$EGFR_LUAD_intogen/EGFR_context_counts_ordered) )
```

### TP53
```{r}
prob_Sherlock_TP53_drivers = sapply(1:nrow(Sherlock_MutProf_LUAD), function(i) Sherlock_MutProf_LUAD[i,]%*%(TP53_drivers_intogen_SBS96$TP53_LUAD_intogen/TP53_context_counts_ordered) )
```

## ESCC across continents
```{r}
prob_ESCC_TP53_drivers = sapply(1:nrow(ESCC_MutProf), function(i) ESCC_MutProf[i,]%*%(ESCC_TP53drivers.SBS.spectra$n/TP53.trans.SBS96.context) )
```

## Mice exposed to 20 carcinogens
Probability of mutation in 186 drivers for each of 181 individuals
```{r}
prob_Riva_drivers.lung.Kras = sapply(1:nrow(Riva_MutProf), function(i) Riva_MutProf[i,]%*% as.matrix(drivers.spectrum.lung.mice.l$Kras$n/Kras.trans.SBS96.context))

prob_Riva_drivers.lung.Fgfr2 = sapply(1:nrow(Riva_MutProf), function(i) Riva_MutProf[i,]%*% as.matrix(drivers.spectrum.lung.mice.l$Fgfr2$n/Fgfr2.trans.SBS96.context))

prob_Riva_drivers.liver.Hras = sapply(1:nrow(Riva_MutProf), function(i) Riva_MutProf[i,]%*% as.matrix(drivers.spectrum.liver.mice.l$Hras$n/Hras.trans.SBS96.context))

prob_Riva_drivers.liver.Braf = sapply(1:nrow(Riva_MutProf), function(i) Riva_MutProf[i,]%*% as.matrix(drivers.spectrum.liver.mice.l$Braf$n/Braf.trans.SBS96.context))

# with all drivers
prob_Riva_drivers.Kras2 = sapply(1:nrow(Riva_MutProf), function(i) Riva_MutProf[i,]%*% as.matrix((colSums((bind_rows(drivers_fig4.lung.spectra,drivers_fig4.liver.spectra) %>% filter(X6=="Kras",!duplicated(paste0(X2,X3,X4,X5))) )[,-(1:10)] ))/Kras.trans.SBS96.context))

prob_Riva_drivers.Fgfr22 = sapply(1:nrow(Riva_MutProf), function(i) Riva_MutProf[i,]%*% as.matrix((colSums((bind_rows(drivers_fig4.lung.spectra,drivers_fig4.liver.spectra) %>% filter(X6=="Fgfr2",!duplicated(paste0(X2,X3,X4,X5))) )[,-(1:10)] ))/Kras.trans.SBS96.context))

prob_Riva_drivers.Hras2 = sapply(1:nrow(Riva_MutProf), function(i) Riva_MutProf[i,]%*% as.matrix((colSums((bind_rows(drivers_fig4.lung.spectra,drivers_fig4.liver.spectra) %>% filter(X6=="Hras",!duplicated(paste0(X2,X3,X4,X5))) )[,-(1:10)] ))/Kras.trans.SBS96.context))

prob_Riva_drivers.Braf2 = sapply(1:nrow(Riva_MutProf), function(i) Riva_MutProf[i,]%*% as.matrix((colSums((bind_rows(drivers_fig4.lung.spectra,drivers_fig4.liver.spectra) %>% filter(X6=="Braf",!duplicated(paste0(X2,X3,X4,X5))) )[,-(1:10)] ))/Kras.trans.SBS96.context))

```


# Computing variability statistics 
We first compute the cosine similarities between mutational signatures, which we will use to weight the differences between signature such that profiles with plenty of similar signatures are not deemed diverse.
## LCINS samples
```{r }
SBS_LUAD_S_cossim <- lsa::cosine(x = Sherlock.refs)
```

```{r }
GS_Sherlock_LUAD = sapply(1:nrow(Sherlock_SBS), function(i) gini_simpson(Sherlock_SBS[i,], S=SBS_LUAD_S_cossim) )
```

## Mice samples
```{r }
SBS_mice_S_cossim <- lsa::cosine(x = Riva.refs)
```

```{r }
GS_Riva = sapply(1:nrow(Riva_SBS), function(i) gini_simpson(Riva_SBS[i,], S=SBS_mice_S_cossim) )
```


# Testing the relationship

Test the relationship between probability of driver and within-tumor variability

## LCINS
```{r }
res.S = tibble(prob.EGFR=prob_Sherlock_EGFR_drivers, prob.TP53=prob_Sherlock_TP53_drivers  ,GS=GS_Sherlock_LUAD)

lm_EGFR_GS = summary(lm(prob.EGFR~GS,data=res.S))
lm_TP53_GS = summary(lm(prob.TP53~GS,data=res.S))
```

## Mice exposed to carcinogens
```{r }
res.Riva.S = tibble(prob.liver.Hras=prob_Riva_drivers.Hras2,
                    prob.liver.Braf=prob_Riva_drivers.Braf2,
                    prob.lung.Fgfr2=prob_Riva_drivers.Fgfr22,
                    prob.lung.Kras=prob_Riva_drivers.Kras2,
                    Exposed = !str_detect(mutsig_carcinogens_mice_SBS$Sample,"SPONTANEOUS"),
                    Chemical = mutsig_carcinogens_mice_SBS$chemical,
                    Tissue=mutsig_carcinogens_mice_SBS$Tissue , 
                    GS=GS_Riva)
res.Riva.S$Chemical[!res.Riva.S$Exposed] = "None"
res.Riva.S$Chemical = relevel(as.factor(res.Riva.S$Chemical),ref = "None")

drivers.liver.chemicals = drivers %>% filter(Tissue=="LIVER") %>% pull(Chemical) %>% unique()
drivers.lung.chemicals = drivers %>% filter(Tissue=="LUNG") %>% pull(Chemical) %>% unique()

# test association cobalt -- Kras and isobutyl nitrite -- Fgfr2 in lung

cor_Hras_GS.liver = (cor.test(res.Riva.S[res.Riva.S$Tissue%in%c("liver"),]$prob.liver.Hras,res.Riva.S[res.Riva.S$Tissue%in%c("liver"),]$GS,method = "spearman"))
lm_Hras_GS.liver = summary(lm(prob.liver.Hras~GS,data=res.Riva.S[res.Riva.S$Tissue%in%c("liver"),])) # makes sense. Only driver in liver
summary(lm(prob.liver.Hras~Exposed,data=res.Riva.S[res.Riva.S$Tissue%in%c("liver"),])) # no effect

cor_Braf_GS.liver = (cor.test(res.Riva.S[res.Riva.S$Tissue%in%c("liver"),]$prob.liver.Braf,res.Riva.S[res.Riva.S$Tissue%in%c("liver"),]$GS,method = "spearman"))
lm_Braf_GS.lung  = summary(lm(prob.liver.Braf~GS,data=res.Riva.S[res.Riva.S$Tissue%in%c("lung"),])) # driver in both. more likely in spontaneous in lung (makes sense with neg assoc), more likely in exposed in liver (makes sens with + assoc)
lm_Braf_GS.liver = summary(lm(prob.liver.Braf~GS,data=res.Riva.S[res.Riva.S$Tissue%in%c("liver"),])) # driver in both. more likely in 
summary(lm(prob.liver.Braf~Exposed+Tissue,data=res.Riva.S[res.Riva.S$Tissue%in%c("lung","liver"),]))

lm_Fgfr2_GS.lung  = summary(lm(prob.lung.Fgfr2~GS,data=res.Riva.S[res.Riva.S$Tissue%in%c("lung"),])) # more likely with GS, makes sense

lm_Kras_GS.lung  = summary(lm(prob.lung.Kras~GS,data=res.Riva.S[res.Riva.S$Tissue%in%c("lung"),])) # more likely in low GS spont liver (makes sense), and low GS lung (not sure if makes sense)
summary(lm(prob.lung.Kras~Exposed+Tissue,data=res.Riva.S[res.Riva.S$Tissue%in%c("lung","liver"),])) 
```

Test association with exposure
```{r}
drivers_fig4.lung$X1 = paste0("LUNG_",str_replace_all(drivers_fig4.lung$X1," ","_"))
drivers_fig4.liver$X1 = paste0("LIVER_",str_replace_all(drivers_fig4.liver$X1," ","_"))

mutsig_carcinogens_mice_SBS.lung_drivers  = left_join(mutsig_carcinogens_mice_SBS,drivers_fig4.lung,by=c(Sample="X1"))
mutsig_carcinogens_mice_SBS.liver_drivers = left_join(mutsig_carcinogens_mice_SBS,drivers_fig4.liver,by=c(Sample="X1"))

# Hras in liver
Spont.Hras.liver.tab = table(Exposed=!str_detect(mutsig_carcinogens_mice_SBS.liver_drivers$Sample[mutsig_carcinogens_mice_SBS.liver_drivers$Tissue=="liver"],"SPONT"),Hras=mutsig_carcinogens_mice_SBS.liver_drivers$X6[mutsig_carcinogens_mice_SBS.liver_drivers$Tissue=="liver"]=="Hras") # more frequent in 

#Braf in both
Spont.Braf.liver.tab = table(Exposed=!str_detect(mutsig_carcinogens_mice_SBS.liver_drivers$Sample[mutsig_carcinogens_mice_SBS.liver_drivers$Tissue=="liver"],"SPONT"), Braf=mutsig_carcinogens_mice_SBS.liver_drivers$X6[mutsig_carcinogens_mice_SBS.liver_drivers$Tissue=="liver"]=="Braf") # more frequent in 
Spont.Braf.lung.tab = table(Exposed=!str_detect(mutsig_carcinogens_mice_SBS.lung_drivers$Sample[mutsig_carcinogens_mice_SBS.lung_drivers$Tissue=="lung"],"SPONT"), Braf=mutsig_carcinogens_mice_SBS.lung_drivers$X6[mutsig_carcinogens_mice_SBS.lung_drivers$Tissue=="lung"]=="Braf") # more frequent in 

#Fgfr2 in lung
Spont.Fgfr2.lung.tab = table(Exposed=!str_detect(mutsig_carcinogens_mice_SBS.lung_drivers$Sample[mutsig_carcinogens_mice_SBS.lung_drivers$Tissue=="lung"],"SPONT"), Braf=mutsig_carcinogens_mice_SBS.lung_drivers$X6[mutsig_carcinogens_mice_SBS.lung_drivers$Tissue=="lung"]=="Fgfr2") # more frequent in 

#Kras in both
Spont.Kras.liver.tab = table(Exposed=!str_detect(mutsig_carcinogens_mice_SBS.liver_drivers$Sample[mutsig_carcinogens_mice_SBS.liver_drivers$Tissue=="liver"],"SPONT"),Kras=mutsig_carcinogens_mice_SBS.liver_drivers$X6[mutsig_carcinogens_mice_SBS.liver_drivers$Tissue=="liver"]=="Kras") # more frequent in 
Spont.Kras.lung.tab = table(Exposed=!str_detect(mutsig_carcinogens_mice_SBS.lung_drivers$Sample[mutsig_carcinogens_mice_SBS.lung_drivers$Tissue=="lung"],"SPONT"), Braf=mutsig_carcinogens_mice_SBS.lung_drivers$X6[mutsig_carcinogens_mice_SBS.lung_drivers$Tissue=="lung"]=="Kras") # more frequent in 

# signif 
fisher.test(Spont.Hras.liver.tab) # Hras a bit more likely in exposed (non signif) => makes sense with GS + corr with prob
fisher.test(Spont.Braf.liver.tab) # Braf liver a bit more likely in unexposed (non signif) 
fisher.test(Spont.Braf.lung.tab)  # Braf liver a more likely in unexposed (non signif)
fisher.test(Spont.Fgfr2.lung.tab)  # Fgfr2 a bit more likely in exposed (non signif)
fisher.test(Spont.Kras.liver.tab) # Braf liver a bit more likely in unexposed (non signif)
fisher.test(Spont.Kras.lung.tab)  # Braf lung more likely in exposed (signif)
```

# Plotting

## Relationship between within-sample diversity and probability of driver alteration
### LCINS
```{r }
gg_EGFR_GS <- ggplot(data=res.S,aes(y=prob.EGFR,x=GS) ) + geom_point()+ stat_smooth(method = "lm",formula = y ~ x,geom = "smooth") + 
  annotate("text",x = 0.1,y=0.002,label=paste0("t-test P=",format(lm_EGFR_GS$coefficients[2,4],digits=2)) ) + 
  #geom_point(alpha=0.1) + geom_point(data=MESOMICS_bootstrap_fava.res.mean,size=4) + stat_ellipse(level=0.90) + 
  xlab("within-sample diversity") + ylab("Probability of EGFR driver alteration") + theme_classic()

gg_TP53_GS <- ggplot(data=res.S,aes(y=prob.TP53,x=GS) ) + geom_point()+ stat_smooth(method = "lm",formula = y ~ x,geom = "smooth") + 
    annotate("text",x = 0.1,y=0.045,label=paste0("t-test P=",format(lm_TP53_GS$coefficients[2,4],digits=2)) ) + 
  #geom_point(alpha=0.1) + geom_point(data=MESOMICS_bootstrap_fava.res.mean,size=4) + stat_ellipse(level=0.90) + 
  xlab("within-sample diversity") + ylab("Probability of TP53 driver alteration") + theme_classic()
```

### Mice exposed to carcinogens
```{r }
gg_RIVA_GS.liver.Hras <- ggplot(data=res.Riva.S %>% filter(Tissue=="liver"),aes(y=prob.liver.Hras,x=GS) ) + geom_point(alpha=0.3)+ 
  stat_smooth(method = "lm",formula = y ~ x,geom = "smooth") + 
  annotate("text",x = 0.1,y=0.00125,label=paste0("P=",format(lm_Hras_GS.liver$coefficients[2,4],digits=2)) ) + 
  xlab("within-sample diversity") + ylab("Probability of Hras driver alteration") + theme_classic() + ggtitle("Liver")

gg_RIVA_GS.liver.Braf <- ggplot(data=res.Riva.S %>% filter(Tissue%in%c("liver") ),aes(y=prob.liver.Braf,x=GS) ) + geom_point(alpha=0.3)+ 
  stat_smooth(method = "lm",formula = y ~ x,geom = "smooth") + 
  annotate("text",x = 0.1,y=0.00065,label=paste0("P=",format(lm_Braf_GS.liver$coefficients[2,4],digits=2)) ) + 
  xlab("within-sample diversity") + ylab("Probability of Braf driver alteration") + theme_classic() + ggtitle("Liver")

gg_RIVA_GS.lung.Fgfr2 <- ggplot(data=res.Riva.S %>% filter(Tissue%in%c("lung") ),aes(y=prob.lung.Fgfr2,x=GS) ) + geom_point(alpha=0.3)+ 
  stat_smooth(method = "lm",formula = y ~ x,geom = "smooth") + 
  annotate("text",x = 0.2,y=0.0020,label=paste0("P=",format(lm_Fgfr2_GS.lung$coefficients[2,4],digits=2)) ) + 
  xlab("within-sample diversity") + ylab("Probability of Fgfr2 driver alteration") + theme_classic() + ggtitle("Lung")

gg_RIVA_GS.lung.Kras <- ggplot(data=res.Riva.S %>% filter(Tissue%in%c("lung") ),aes(y=prob.lung.Kras,x=GS) ) + geom_point(alpha=0.3)+ 
  stat_smooth(method = "lm",formula = y ~ x,geom = "smooth") + 
  annotate("text",x = 0.2,y=0.0020,label=paste0("P=",format(lm_Kras_GS.lung$coefficients[2,4],digits=2)) ) + 
  xlab("within-sample diversity") + ylab("Probability of Kras driver alteration") + theme_classic() + ggtitle("Lung")


ggsave( gg_RIVA_GS.liver.Hras+ gg_RIVA_GS.liver.Braf + gg_RIVA_GS.lung.Fgfr2 + gg_RIVA_GS.lung.Kras ,
        filename = "../../Fig4c_mice_probs_draft.svg",height = 2.5*2,width = 3*2)
```

## Spectra of driver mutations

### LCINS
```{r}
EGFR_drivers_intogen_SBS96$EGFR_LUAD_intogen.norm = EGFR_drivers_intogen_SBS96$EGFR_LUAD_intogen/EGFR_context_counts_ordered

gg_EGFR_spectrum = ggplot(EGFR_drivers_intogen_SBS96,aes(x=paste0(Type,Subtype),y= EGFR_LUAD_intogen.norm,fill=Type) ) + geom_col() +
  theme_classic() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + xlab("Mutation type") + ylab("Proportion of drivers")

TP53_drivers_intogen_SBS96$TP53_LUAD_intogen.norm = TP53_drivers_intogen_SBS96$TP53_LUAD_intogen/TP53_context_counts_ordered

gg_TP53_spectrum = ggplot(TP53_drivers_intogen_SBS96,aes(x=paste0(Type,Subtype),y= TP53_LUAD_intogen.norm,fill=Type) ) + geom_col() +
  theme_classic() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + xlab("Mutation type") + ylab("Proportion of drivers")
```

### Mice exposed to carcinogens
```{r}
mutprof_carcinogens_mice_SBS.norm = mutprof_carcinogens_mice_SBS #/EGFR_context_counts_ordered

gg_Riva_drivers_spectrum = sigvar::plot_SBS_spectrum(tibble(Drivers=rowSums(mutprof_carcinogens_mice_SBS.norm[,-(1:3)])) )  + ylab("Proportion of drivers")
```

## Average spectra of low- and high-diversity samples

###
```{r}
GSspectra = tibble(MutationType=paste0(MutType$Type,",",MutType$Subtype) , Type=MutType$Type, Subtype=MutType$Subtype,
       Proportion.lowGS  = Sherlock_MutProf_LUAD[which.min(GS_Sherlock_LUAD),],
       Proportion.highGS = Sherlock_MutProf_LUAD[which.max(GS_Sherlock_LUAD),] )

gg_lowGS_spectrum = ggplot(GSspectra,aes(x=MutationType,y= Proportion.lowGS,fill=Type) ) + 
  geom_col() + theme_classic()+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + xlab("Mutation type")+ ylab("Proportion of alterations") + ggtitle("Lowest diversity sample") + ylim(c(0,0.11))

SBSpie_lowGS = tibble(SBS=colnames(Sherlock_SBS),Proportions=Sherlock_SBS[which.min(GS_Sherlock_LUAD),])[Sherlock_SBS[which.min(GS_Sherlock_LUAD),]>0,]
SBSpie_lowGS$Pos = SBSpie_lowGS$Proportions/2+cumsum(c(0,SBSpie_lowGS$Proportions[-2]) )
SBSpie_lowGS$SBS = factor(SBSpie_lowGS$SBS,levels=rev(SBSpie_lowGS$SBS))

gg_lowGS_props = ggplot(SBSpie_lowGS, aes(x="",y=Proportions,fill=SBS) ) + 
  geom_bar(stat="identity", width=1, color="white") +  coord_polar("y", start=0) + 
  geom_label_repel(aes(y=Pos,label = SBS), nudge_x = 1, 
                   size = 3, show.legend = FALSE) + 
  theme_void() + scale_fill_manual(values = sbs_palette[]) + guides(fill="none")

# creating layout
layout <- c(
  area(t = 1, l = 1, b = 4, r = 6),
  area(t = 1, l = 5, b = 3, r = 6)
)

gg_lowGS_spectrum_props = gg_lowGS_spectrum + gg_lowGS_props + plot_layout(design = layout)


gg_highGS_spectrum = ggplot(GSspectra,aes(x=MutationType,y= Proportion.highGS,fill=Type) ) + 
  geom_col() + theme_classic()+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + xlab("Mutation type")+ ylab("Proportion of alterations") + ggtitle("Highest diversity sample") + ylim(c(0,0.11))

SBSpie_highGS = tibble(SBS=colnames(Sherlock_SBS),Proportions=Sherlock_SBS[which.max(GS_Sherlock_LUAD),])[Sherlock_SBS[which.max(GS_Sherlock_LUAD),]>0,]
SBSpie_highGS$Pos = SBSpie_highGS$Proportions/2+cumsum(c(0,SBSpie_highGS$Proportions[-6]) )
SBSpie_highGS$SBS = factor(SBSpie_highGS$SBS,levels=rev(SBSpie_highGS$SBS))

gg_highGS_props = ggplot(SBSpie_highGS, aes(x="",y=Proportions,fill=SBS) ) + 
  geom_col(width=1, color="white") +  coord_polar("y",start=0) + 
  geom_label_repel(aes(y=Pos,label = SBS), nudge_x = 1, 
                   size = 3, show.legend = FALSE,label.padding = 0.1,box.padding = 0.1,force = 5) + 
  theme_void() + scale_fill_manual(values = sbs_palette[]) + guides(fill="none")

gg_highGS_spectrum_props = gg_highGS_spectrum + gg_highGS_props + plot_layout(design = layout)
```

## Association with Riva et al. driver results

```{r}
driver.tib = left_join(bind_cols(sample=rownames(Riva_SBS),Riva_SBS,GS=GS_Riva),drivers)
driver.tib = left_join(driver.tib,mice_metadata,by=c(sample="Sample"))
driver.tib$chemical[str_detect(driver.tib$sample,"SPONTANEOUS")] = "spontaneous"

library(ggbeeswarm)

#summary( lm(GS~Tissue.x+!(signature=="mSBS1"|signature=="mSBS5"|signature=="mSBS40"),data = driver.tib %>% filter(Tissue.x%in%c("lung","liver")) ) )

driver.tib$signature = factor(driver.tib$signature,levels=c("mSBS1","mSBS5","mSBS40","mSBS12","mSBS17","mSBS18","mSBS19","mSBS_N1"))

driver.tib.liver = driver.tib %>% filter(!is.na(driver.tib$signature ),Tissue.x=="LIVER") %>% group_by(GS_group=GS>=median(GS),signature) %>% summarize(n=n()) %>% ungroup() %>% group_by(GS_group) %>% mutate(Activity=n/sum(n))

gg_drivers_riva_mut.liver = ggplot(driver.tib.liver, aes(x=GS_group,y=Activity, fill=signature)) + geom_col() + 
  geom_segment(data = driver.tib.liver[2,],aes(x=1.5,xend=2.5,y=1-Activity,yend=1-Activity),col="white",linewidth=2) + 
  scale_fill_manual(values=sbs_palette) + theme_classic() + ylab("Mean activity") + scale_y_continuous(limits = c(0,1))

driver.tib.lung = driver.tib %>% filter(!is.na(driver.tib$signature ),Tissue.x=="LUNG") %>% group_by(GS_group=GS>=median(GS),signature) %>% summarize(n=n()) %>% ungroup() %>% group_by(GS_group) %>% mutate(Activity=n/sum(n))

gg_drivers_riva_mut.lung  = ggplot(driver.tib.lung, aes(x=GS_group,y=Activity,fill=signature)) + geom_col() + 
  geom_segment(data = driver.tib.lung %>% filter(signature %in% c("mSBS1","mSBS5","mSBS40")) %>% summarize(Activity=sum(Activity)),aes(x=0:1 + .5,xend=0:1+1.5,y=1-Activity,yend=1-Activity),col="white",linewidth=2,inherit.aes = F) + 
  scale_fill_manual(values=sbs_palette) + theme_classic() + scale_y_continuous(limits = c(0,1))

ggsave( gg_drivers_riva_mut.liver+ gg_drivers_riva_mut.lung ,filename = "../../Fig4a_draft.svg",h=3,w=3*2)

## diversity of responsible signatures
driver.tib.liver = driver.tib %>% filter(!is.na(driver.tib$signature ),Tissue=="liver") %>% group_by(GS>=median(GS),signature) %>% summarize(n=n()) %>% 
  ungroup() %>% pivot_wider(names_from=signature,values_from = n,values_fill = 0) 
fisher.test( as.matrix(driver.tib.liver[,-1]) ) 
#age vs other
fisher.test( cbind(driver.tib.liver[,2],rowSums(driver.tib.liver[,3:5])) ) 

driver.tib.lung  = driver.tib %>% filter(!is.na(driver.tib$signature ),Tissue=="lung") %>% group_by(GS>=median(GS),signature) %>% summarize(n=n()) %>% 
  ungroup() %>% pivot_wider(names_from=signature,values_from = n,values_fill = 0)

fisher.test( as.matrix(driver.tib.lung[,-1]) )
#age vs other
fisher.test( cbind(rowSums(driver.tib.lung[,2:4]),rowSums(driver.tib.lung[,5:7])) ) 

## diversity
driver.tib.lung.props  = sweep(driver.tib.lung[,-1],1,rowSums(driver.tib.lung[,-1]),"/")
driver.tib.liver.props = sweep(driver.tib.liver[,-1],1,rowSums(driver.tib.liver[,-1]),"/")

div.drivers.lung.lowGS = FAVA::gini_simpson_mean(driver.tib.lung.props[1,],S =SBS_mice_S_cossim[colnames(driver.tib.lung.props),colnames(driver.tib.lung.props)] )
div.drivers.lung.highGS = FAVA::gini_simpson_mean(driver.tib.lung.props[2,],S =SBS_mice_S_cossim[colnames(driver.tib.lung.props),colnames(driver.tib.lung.props)] )

div.drivers.liver.lowGS = FAVA::gini_simpson_mean(driver.tib.liver.props[1,],S =SBS_mice_S_cossim[colnames(driver.tib.liver.props),colnames(driver.tib.liver.props)] )
div.drivers.liver.highGS = FAVA::gini_simpson_mean(driver.tib.liver.props[2,],S =SBS_mice_S_cossim[colnames(driver.tib.liver.props),colnames(driver.tib.liver.props)] )

div.drivers.tib =tibble(Diversity=c(div.drivers.lung.lowGS,div.drivers.lung.highGS,div.drivers.liver.lowGS,div.drivers.liver.highGS),
       Tissue=c("lung","lung","liver","liver"),WS_diversity.group=factor(rep(c("Low","High"),2) ,levels=c("Low","High")) )

ggdivdiv = ggplot(div.drivers.tib,aes(x=WS_diversity.group,y=Diversity)) + geom_point() + geom_path(group=1) + facet_wrap(.~Tissue)  +
  theme_classic() + xlab("Within-sample diversity") + ylab("Diversity of responsible signatures")


ggsave( ggdivdiv ,filename = "../../Fig4b_divdiv_draft.svg",h=3,w=3*2)

##### 
driversigs = ggplot(driver.tib[str_detect(driver.tib$sample,"LIVER"),], aes(x=!str_detect(sample,"SPONT"),y=GS)) + geom_violin() + geom_beeswarm(aes(col=signature)) + coord_flip() + theme_classic() + ylab("Within-sample diversity") + xlab("Exposure")

ggplot(driver.tib[str_detect(driver.tib$sample,"LIVER"),], aes(x=signature,y=GS)) + geom_violin() + geom_beeswarm(aes(col=signature)) + coord_flip() + theme_classic() + ylab("Within-sample diversity") + xlab("Exposure")

ggplot(driver.tib[str_detect(driver.tib$sample,"LUNG"),], aes(x=!str_detect(sample,"SPONT"),y=GS)) + 
  geom_violin() + geom_beeswarm(aes(col=signature)) + coord_flip() + theme_classic()

ggplot(driver.tib[str_detect(driver.tib$sample,"LUNG"),], aes(x=!str_detect(sample,"SPONT"),y=GS)) + 
  geom_violin() + geom_beeswarm(aes(col=signature)) + coord_flip() + theme_classic()

ggplot(driver.tib[str_detect(driver.tib$sample,"LIVER"),], aes(x=gene,y=GS,col=!str_detect(sample,"SPONTANEOUS"))) + geom_boxplot() # diverse spontaneous are more likely to have a driver gene

ggplot(driver.tib[str_detect(driver.tib$sample,"LUNG"),], aes(x=gene,y=GS,col=!str_detect(sample,"SPONTANEOUS"))) + geom_boxplot() # diverse spontaneous are more likely to have a driver gene


glm_drivers_GS = glm(!is.na(gene)~GS+Tissue + !str_detect(sample,"SPONTANEOUS"),
                     family=binomial(link='logit'), data = driver.tib %>% filter(Tissue%in%c("lung","liver")) )
summary(glm_drivers_GS)

summary( lm(GS~Tissue+gene + !str_detect(sample,"SPONTANEOUS"),data = driver.tib %>% filter(Tissue%in%c("lung","liver")) ) )

```

## Look at protein structure and position of drivers
```{r}

```

## Assembling all panels
```{r }
(gg_EGFR_GS + (gg_EGFR_spectrum + ggtitle("EGFR driver mutations"))  + gg_lowGS_spectrum_props +  gg_TP53_GS + (gg_TP53_spectrum+ggtitle("TP53 driver mutations")) + gg_highGS_spectrum_props ) +  plot_annotation(tag_levels = 'a') + plot_layout(widths = c(1, 2,2)) & theme(plot.tag = element_text(face = 'bold'))

```

# Session information

```{r }
sessionInfo()
```

