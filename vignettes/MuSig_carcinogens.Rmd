---
title: "sigFAVA analysis of the mutational signatures of carcinogens"
author:
  - name: "Nicolas Alcala"
    affiliation: "Rare Cancers Genomics Team, International Agency for Research on Cancer / World Health Organization"
    email: "alcalan@iarc.who.int"
date: "`r Sys.Date()`"
output:
  BiocStyle::html_document:
    toc: true
    toc_depth: 2
vignette: >
  %\VignetteIndexEntry{Mutational signatures of carcinogens}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(sigvar)
library(FAVA)
library(ggplot2)
library(stringr)
library(dplyr)
library(patchwork)
```

# Introduction

This vignette details an example of using sigFAVA to detect the effect of exposure to a carcinogen on the variability of mutational signatures. 

# Datasets
This vignettes analyses two public datasets included in the sigFAVA package.

## Mutational signatures of tumors from mice exposed to known or suspected carcinogens (Riva et al. Nat Genet 2020)
This dataset was assembled from the supplementary data from Riva et al. 2020. It contains COSMIC mice single base substitution mutational signatures (mSBS) along with the tissue where the tumor originated and the chemical substances to which the mouse was exposed, with "spontaneous" being the control tumors arising spontaneously in the absence of any exposure.

```{r }
head(mutsig_carcinogens_mice_SBS)
```

## Mutational signatures of malignant pleural mesothelioma patients with various degrees of asbestos exposure (Mangiante et al. Nat Genet 2023)
This dataset was assembled from supplementary tables from Mangiante et al. 2023. It contains metadata (ID, sex, age, exposure), COSMIC copy number signatures (CN1, CN2, etc), and COSMIC single base substitution signatures (SBS1, SBS2, etc).
```{r }
head(MESOMICS_CN_SBS)
```

For the purpose of this analysis, we will use the Asbestos.Score column, which contains an asbestos score which is the product of exposure probability, intensity, and duration, in units of "years with certain, constant exposure at intensity 1", similar to the concept of pack-years used to quantify exposure to cigarette smoking. For instance, a frequent (1) but uncertain exposure (probability 0.5) of medium intensity (2) for 10 years leads to a score of 1*0.5*2*10=10, similar to that of a frequent (1), certain (probability of 1), low-intensity (1) exposure of 10 years. This score is available for 47 patients, among which 45 have whole-genome sequencing data available and thus mutational signature data.

```{r }
ggplot(MESOMICS_CN_SBS,aes(x=Asbestos.Score)) + geom_histogram(stat="count") + theme_classic()

table(!is.na(MESOMICS_CN_SBS$Asbestos.Score),!is.na(MESOMICS_CN_SBS$`CNB (number of segments)`))
```

### Data preparation
We compute proportions rather than counts for each signature, keeping the ID and asbestos score information, and removing samples without whole-genome sequencing data:
```{r}
MESOMICS_CN = MESOMICS_CN_SBS[,str_detect(colnames(MESOMICS_CN_SBS),"^CN[0-9]+") ]
MESOMICS_CN = sweep(MESOMICS_CN,1,rowSums(MESOMICS_CN),"/")
MESOMICS_CN = bind_cols(Sample=MESOMICS_CN_SBS$Sample , Asbestos.Score=MESOMICS_CN_SBS$Asbestos.Score, as_tibble(MESOMICS_CN))
MESOMICS_CN = MESOMICS_CN[colSums(apply(MESOMICS_CN[,-1],1,is.na))==0,] %>% arrange(Asbestos.Score)
```


# Computing variability statistics
We first compute the cosine similarities between mutational signatures, which we will use to weight the differences between signature such that profiles with plenty of similar signatures are not deemed diverse.
```{r }
CN_cossim <- lsa::cosine(x = COSMIC3.1_CN[,-1] %>% as.matrix)
SBSmm_cossim <- lsa::cosine(x = COSMIC3.3.1_SBS_mm10[,-1] %>% as.matrix)
```

Because the Riva et al. 2020 signatures do not exactly match COSMIC signatures, we used the closest signature mentioned in Table 4 to compute cosine similarities. mSBS17 from the study presented the T>G excess found in COSMIC mSBS17b, so we chose this signature as reference, and mSBS_N3 was closest to mSBS39, and both mSBS_N1 and mSBS_N2 were closest to mSBS25.
```{r }
colnames(SBSmm_cossim) = paste0("m",colnames(SBSmm_cossim))
rownames(SBSmm_cossim) = paste0("m",rownames(SBSmm_cossim))
siglist = c(colnames(mutsig_carcinogens_mice_SBS)[2:4] , "mSBS17b" , colnames(mutsig_carcinogens_mice_SBS)[6:9],
               "mSBS25","mSBS25","mSBS39")
SBSmm_cossim = SBSmm_cossim[siglist,siglist]
colnames(SBSmm_cossim)[4]  = rownames(SBSmm_cossim)[4]  = "mSBS17"
colnames(SBSmm_cossim)[9]  = rownames(SBSmm_cossim)[9]  = "mSBS_N1"
colnames(SBSmm_cossim)[10] = rownames(SBSmm_cossim)[10] = "mSBS_N2"
colnames(SBSmm_cossim)[11] = rownames(SBSmm_cossim)[11] = "mSBS_N3"
```

## Taking into account the asbestos score
We first compute weights for each sample depending on its asbestos score using a gaussian kernel, putting emphasis on either weak, intermediate, or strong exposures (centered around no exposure, median exposure, and max exposure), using a bandwidth of 1 standard deviation in asbestos score. We use the log scale for asbestos scores in order to account for their different orders of magnitude.
```{r }
MESOMICS_CN$Asbestos.Score.log10 = log(MESOMICS_CN$Asbestos.Score+1,10)

bw = sd(MESOMICS_CN$Asbestos.Score.log10)
w.asb = sapply(quantile(MESOMICS_CN$Asbestos.Score.log10,c(0,1)), function(x) dnorm(MESOMICS_CN$Asbestos.Score.log10,x,bw))
w.asb = sweep(w.asb,2, colSums(w.asb),"/")
```

## Computing within- and between-sample variability
We compute the Gini-Simpson index of all individuals with regards to their CN signatures to quantify intra-patient variability. We use FST to quantify the inter-patient variability of mutational signatures. We compute weighted statistics using bootstrapping for each group and merge the results.

### 20 Known and suspected carcinogens
```{r }
set.seed(0)
Riva_bootstrap_fava.lung  = bootstrap_fava(mutsig_carcinogens_mice_SBS[mutsig_carcinogens_mice_SBS$Tissue=="lung",c(25,2:12)],
                                          S=SBSmm_cossim,n_replicates = 1000,group = "chemical")
Riva_bootstrap_fava.liver = bootstrap_fava(mutsig_carcinogens_mice_SBS[mutsig_carcinogens_mice_SBS$Tissue=="liver",c(25,2:12)],
                                          S=SBSmm_cossim,n_replicates = 1000,group = "chemical")
Riva_bootstrap_fava.kidney = bootstrap_fava(mutsig_carcinogens_mice_SBS[mutsig_carcinogens_mice_SBS$Tissue=="kidney",c(2:12)],
                                          S=SBSmm_cossim,n_replicates = 1000)
Riva_bootstrap_fava.stomach = bootstrap_fava(mutsig_carcinogens_mice_SBS[mutsig_carcinogens_mice_SBS$Tissue=="stomach",c(2:12)],
                                          S=SBSmm_cossim,n_replicates = 1000)

Riva_bootstrap_fava.lung$statistics$Tissue    = "Lung"
Riva_bootstrap_fava.liver$statistics$Tissue   = "Liver"
Riva_bootstrap_fava.kidney$statistics$Tissue  = "Kidney"
Riva_bootstrap_fava.stomach$statistics$Tissue = "Forestomach"
Riva_bootstrap_fava.kidney$statistics$chemical  = "vinylidene chloride"
Riva_bootstrap_fava.stomach$statistics$chemical = "1,2,3-Trichloropropane"

Riva_bootstrap_fava.res = bind_rows(Riva_bootstrap_fava.lung$statistics, Riva_bootstrap_fava.liver$statistics,
                                    Riva_bootstrap_fava.kidney$statistics,Riva_bootstrap_fava.stomach$statistics) 
Riva_bootstrap_fava.res.mean = Riva_bootstrap_fava.res %>% group_by(chemical) %>%
  summarize(FAVA=mean(FAVA),gini_simpson_mean=mean(gini_simpson_mean))
```

### MESOMICS
```{r }
set.seed(0)
MESOMICS_bootstrap_fava.low            = bootstrap_fava(MESOMICS_CN[,c(3:9)],S=SBSmm_cossim,n_replicates = 1000,w = w.asb[,1])
MESOMICS_bootstrap_fava.high           = bootstrap_fava(MESOMICS_CN[,c(3:9)],S=SBSmm_cossim,n_replicates = 1000,w = w.asb[,2])

MESOMICS_bootstrap_fava.low$statistics$group = "Weak asbestos exposure"
MESOMICS_bootstrap_fava.high$statistics$group = "Strong asbestos exposure"

MESOMICS_bootstrap_fava.res = bind_rows(MESOMICS_bootstrap_fava.low$statistics, MESOMICS_bootstrap_fava.high$statistics) 
MESOMICS_bootstrap_fava.res.mean = MESOMICS_bootstrap_fava.res %>% group_by(group) %>%
  summarize(FAVA=mean(FAVA),gini_simpson_mean=mean(gini_simpson_mean))
```

# Plotting
Asbestos exposure
```{r }
gg_asbestos <- ggplot(MESOMICS_bootstrap_fava.res , aes(x=gini_simpson_mean,y=FAVA,col=group)) + 
  geom_point(alpha=0.1) + geom_point(data=MESOMICS_bootstrap_fava.res.mean,size=4) + stat_ellipse(level=0.90) + 
  xlab("Mean within-sample variability") + ylab("Across-sample\nvariability") + theme_classic()
```

## Assembling all panels
```{r }
gg_asbestos
```

# Session information

```{r }
sessionInfo()
```

